<polymer-element name="g-engine" attributes="" extends="">
  <template>
    <content></content>
  </template>
  <script>
    Polymer('g-engine', {
      ready: function () {
        this.frame = 0;
        this.time = performance.now();
        this.onUpdate = this.onUpdate.bind(this);
        this.onAddWorld = this.onAddWorld.bind(this);
        this.worlds = {};
        this.dispatchBatch = [];

        this.addEventListener('AddWorld', this.onAddWorld, false);
        window.addEventListener("keypress", this.registerEvent.bind(this));

        requestAnimationFrame(this.onUpdate);
      },
      registerEvent: function(event) {
        //TODO: recognize when button is held down
        if (event.charCode == 32) {
          var notification = new CustomEvent('dispatch', { 'detail': 'space' });
          this.dispatchBatch.push(notification);
        }
      },
      dispatchEvents: function() {
        while (this.dispatchBatch.length != 0) {
          var event = this.dispatchBatch.pop();
          window.dispatchEvent(event);
        }
      },
      onAddWorld: function(event) {
        event.preventDefault();
        event.stopPropagation();
        var world = event.detail;
        this.worlds[world.id] = world;
      },
      onRemoveWorld: function(event) {

      },
      onUpdate: function () {
        ++ this.frame;
        var now = performance.now();
        var dt = now - this.time;
        this.time = now;
        // console.info('frame, dt:', this.frame, dt);
        requestAnimationFrame(this.onUpdate);
        this.dispatchEvents();
      }
    });
  </script>
</polymer-element>
